<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Learn Hiragana</title>
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <header class="container header">
      <button id="hiraganaMode" class="mode hide" onclick="mode(HIRAGANA)">Learn Hiragana</button>
      <button id="katakanaMode" class="mode hide" onclick="mode(KATAKANA)">Learn Katakana</button>
      <button id="quiz" onclick="quiz()" class="mode hide quiz">Quiz</button>
      <button onclick="start(true)" id="start">Start</button>
      <div id="score"></div>
      <button onclick="start()" class="hide restart" id="restart">Restart</button>
    </header>
    <div class="main hor">
      <div id="boxes" class="container boxes">
      </div>
      <div id="hiraganas" class="container images">
      </div>
    </div>
    <script src="easytimer.min.js" type="text/javascript"></script>
    <script>
      const hiraganaStart = 12353;//3041;
      const hiraganaEnd = 12447;//3096;
      const hiraganaContainer = document.getElementById('hiraganas');
      const boxContainer = document.getElementById('boxes');
      const HIRAGANA = 'hiragana';
      const KATAKANA = 'katakana';
      const QUIZ = 'quiz';
      let currentMode = HIRAGANA;

      //https://www.key-shortcut.com/en/writing-systems/%E3%81%B2%E3%82%89%E3%81%8C%E3%81%AA-japanese/
      //http://jrgraphix.net/r/Unicode/3040-309F

      function allowDrop(ev) {
        ev.preventDefault();
      }

      function mode(m) {
        currentMode = m
        switch (m) {
          case HIRAGANA:
            document.getElementById('hiraganaMode').classList.add('hide');
            document.getElementById('katakanaMode').classList.remove('hide');
            document.getElementsByClassName('main')[0].classList.remove('hor');
            start();        
            break;
          case KATAKANA:
            document.getElementById('hiraganaMode').classList.remove('hide');
            document.getElementById('katakanaMode').classList.add('hide');
            document.getElementsByClassName('main')[0].classList.remove('hor');
            start();
            break;
          case QUIZ:
            document.getElementById('hiraganaMode').classList.add('hide');
            document.getElementById('katakanaMode').classList.remove('hide');
            document.getElementsByClassName('main')[0].classList.add('hor');
            quiz();
            break;
        }
      }

      function drop(ev) {
        ev.preventDefault();
        let data = ev.dataTransfer.getData("code");
        let hiraganaBox = document.getElementById(data);
        let dropCode = ev.target.dataset.code || ev.target.parentElement.dataset.code;
        let arrItem = hiragana.find(function(item) {
          return item.sound === data;
        });
        if(data === dropCode) {
          ev.target.innerHTML = "<b>" + dropCode + "</b>" + hiraganaBox.innerHTML;
          ev.target.classList.add('done')
          let wClass = getTriesClass(arrItem.tries);
          if(!!wClass) {
            ev.target.classList.add(wClass);
          }
          hiraganaBox.remove();
        } else {
          
          arrItem.tries = arrItem.tries || 0;
          arrItem.tries++;
          hiraganaBox.children[1].innerText = arrItem.tries;
          let wClass = getTriesClass(arrItem.tries);
          if(!!wClass) {
            hiraganaBox.classList.add(wClass);
          }
        }
      }

      const timer = new Timer();

      function getTriesClass(tries) {
        if(tries < 3){
          return '';
        } else if(tries < 5) {
          return 'w1';
        } else if(tries < 7) {
          return 'w2';
        } else if(tries < 10) {
          return 'w3';
        } else {
          return 'w4';
        }
      }

      let quizCopy;
      let quizAns;
      let score = 0;
      function quiz() {
        quizCopy = hiragana.slice();
        quizAns = hiragana.slice();
        if(timer.isRunning) {
          timer.stop();
        }
        score = 0;
        quizLoop();

      }

      function quizLoop() {
        document.getElementById('score').innerHTML = score + '';
        let rnd = Math.floor(Math.random() * quizCopy.length);
        let item = quizCopy[rnd];
        let newSpan = `<div id="${item.sound}" class="dragbox box big" title="${item.sound}"><span>${currentMode == HIRAGANA ? item.hiragana : item.katakana}</span></div>`
        quizCopy.splice(rnd, 1);
        boxContainer.innerHTML = newSpan;

        let answers = [];
        for(let i = 1; i <= 4; i++) {
          let rnd = Math.floor(Math.random() * quizAns.length);
          let item = quizAns[rnd];
          answers.push(`<div id="${item.sound}" onclick="answer(false, this)" class="dragbox box" title="${item.sound}"><span>${item.sound}</span></div>`);
        }
        rnd = Math.floor(Math.random() * 4);
        answers.splice(rnd, 0, `<div id="correct" onclick="answer(true, this)" class="dragbox box correct" title="${item.sound}"><span>${item.sound}</span></div>`)
        hiraganaContainer.innerHTML = answers.join('');
      }

      function answer(real, elem) {
        if(real) {
          score += 100;
          elem.classList.add('dropbox', 'done');
        } else {
          score -= 20;
          elem.classList.add('dropbox', 'done', 'w4');
          document.getElementById('correct').classList.add('dropbox', 'done');     
        }
        setTimeout(quizLoop, 1000);
      }

      function start(firstTime) {
        if(firstTime) {
          document.getElementById('hiraganaMode').classList.add('hide');
          document.getElementById('katakanaMode').classList.remove('hide');
        }
        if(timer.isRunning) {
          timer.stop();
        }
        let newSpan = '';
        let dropSpan = '';
        timer.start();
        timer.removeEventListener('secondsUpdated');
        timer.addEventListener('secondsUpdated', function (e) {
            document.getElementById('score').innerHTML = timer.getTimeValues().toString();
        });

        hiragana.forEach(item => {
          dropSpan += `<div class="dropbox box" ondrop="drop(event)" ondragover="allowDrop(event)" data-code="${item.sound}">${item.sound}</div>`
        });

        let hiraganaCopy = hiragana.slice();
        while(hiraganaCopy.length) {
          let rnd = Math.floor(Math.random() * hiraganaCopy.length);
          let item = hiraganaCopy[rnd];
          newSpan += `<div draggable="true" id="${item.sound}" ondragstart="drag(event)" class="dragbox box" title="${item.sound}"><span>${currentMode == HIRAGANA ? item.hiragana : item.katakana}</span><i>${item.tries || ''}</i></div>`
          hiraganaCopy.splice(rnd, 1);
        }
        
        hiraganaContainer.innerHTML = newSpan;
        boxContainer.innerHTML = dropSpan;

        document.getElementById('start').classList.add('hide');
        document.getElementById('restart').classList.remove('hide');
        document.getElementById('quiz').classList.remove('hide');
        document.getElementById('score').innerHTML = '00:00:00';
      }

      function drag(ev) {
        ev.dataTransfer.setData("code", ev.target.id);
      }

      const hiragana = [
        {"sound":"A","hiragana":"あ", "katakana": "ア", "tries": null},
        {"sound":"I","hiragana":"い", "katakana": "イ", "tries": null},
        {"sound":"U","hiragana":"う", "katakana": "ウ", "tries": null},
        {"sound":"E","hiragana":"え", "katakana": "エ", "tries": null},
        {"sound":"O","hiragana":"お", "katakana": "オ", "tries": null},
        {"sound":"KA","hiragana":"か", "katakana": "カ", "tries": null},
        {"sound":"KI","hiragana":"き", "katakana": "キ", "tries": null},
        {"sound":"KU","hiragana":"く", "katakana": "ク", "tries": null},
        {"sound":"KE","hiragana":"け", "katakana": "ケ", "tries": null},
        {"sound":"KO","hiragana":"こ", "katakana": "コ", "tries": null},
        {"sound":"GA","hiragana":"が", "katakana": "ガ", "tries": null},
        {"sound":"GI","hiragana":"ぎ", "katakana": "ギ", "tries": null},
        {"sound":"GU","hiragana":"ぐ", "katakana": "グ", "tries": null},
        {"sound":"GE","hiragana":"げ", "katakana": "ゲ", "tries": null},
        {"sound":"GO","hiragana":"ご", "katakana": "ゴ", "tries": null},
        {"sound":"SA","hiragana":"さ", "katakana": "サ", "tries": null},
        {"sound":"SHI","hiragana":"し", "katakana": "シ", "tries": null},
        {"sound":"SU","hiragana":"す", "katakana": "ス", "tries": null},
        {"sound":"SE","hiragana":"せ", "katakana": "セ", "tries": null},
        {"sound":"SO","hiragana":"そ", "katakana": "ソ", "tries": null},
        {"sound":"ZA","hiragana":"ざ", "katakana": "ザ", "tries": null},
        {"sound":"JI","hiragana":"じ", "katakana": "ジ", "tries": null},
        {"sound":"ZU","hiragana":"ず", "katakana": "ズ", "tries": null},
        {"sound":"ZE","hiragana":"ぜ", "katakana": "ゼ", "tries": null},
        {"sound":"ZO","hiragana":"ぞ", "katakana": "ゾ", "tries": null},
        {"sound":"TA","hiragana":"た", "katakana": "タ", "tries": null},
        {"sound":"CHI","hiragana":"ち", "katakana": "チ", "tries": null},
        {"sound":"TSU","hiragana":"つ", "katakana": "ツ", "tries": null},
        {"sound":"TE","hiragana":"て", "katakana": "テ", "tries": null},
        {"sound":"TO","hiragana":"と", "katakana": "ト", "tries": null},
        {"sound":"DA","hiragana":"だ", "katakana": "ダ", "tries": null},
        {"sound":"JI","hiragana":"ぢ", "katakana": "ヂ", "tries": null},
        {"sound":"ZU","hiragana":"づ", "katakana": "ヅ", "tries": null},
        {"sound":"DE","hiragana":"で", "katakana": "デ", "tries": null},
        {"sound":"DO","hiragana":"ど", "katakana": "ド", "tries": null},
        {"sound":"NA","hiragana":"な", "katakana": "ナ", "tries": null},
        {"sound":"NI","hiragana":"に", "katakana": "ニ", "tries": null},
        {"sound":"NU","hiragana":"ぬ", "katakana": "ヌ", "tries": null},
        {"sound":"NE","hiragana":"ね", "katakana": "ネ", "tries": null},
        {"sound":"NO","hiragana":"の", "katakana": "ノ", "tries": null},
        {"sound":"HA","hiragana":"は", "katakana": "ハ", "tries": null},
        {"sound":"HI","hiragana":"ひ", "katakana": "ヒ", "tries": null},
        {"sound":"FU","hiragana":"ふ", "katakana": "フ", "tries": null},
        {"sound":"HE","hiragana":"へ", "katakana": "ヘ", "tries": null},
        {"sound":"HO","hiragana":"ほ", "katakana": "ホ", "tries": null},
        {"sound":"BA","hiragana":"ば", "katakana": "バ", "tries": null},
        {"sound":"BI","hiragana":"び", "katakana": "ビ", "tries": null},
        {"sound":"BE","hiragana":"べ", "katakana": "ベ", "tries": null},
        {"sound":"BU","hiragana":"ぶ", "katakana": "ブ", "tries": null},
        {"sound":"BO","hiragana":"ぼ", "katakana": "ボ", "tries": null},
        {"sound":"PA","hiragana":"ぱ", "katakana": "パ", "tries": null},
        {"sound":"PI","hiragana":"ぴ", "katakana": "ピ", "tries": null},
        {"sound":"PU","hiragana":"ぷ", "katakana": "プ", "tries": null},
        {"sound":"PE","hiragana":"ぺ", "katakana": "ペ", "tries": null},
        {"sound":"PO","hiragana":"ぽ", "katakana": "ポ", "tries": null},
        {"sound":"MA","hiragana":"ま", "katakana": "マ", "tries": null},
        {"sound":"MI","hiragana":"み", "katakana": "ミ", "tries": null},
        {"sound":"MU","hiragana":"む", "katakana": "ム", "tries": null},
        {"sound":"ME","hiragana":"め", "katakana": "メ", "tries": null},
        {"sound":"MO","hiragana":"も", "katakana": "モ", "tries": null},
        {"sound":"YA","hiragana":"や", "katakana": "ヤ", "tries": null},
        {"sound":"YU","hiragana":"ゆ", "katakana": "ユ", "tries": null},
        {"sound":"YO","hiragana":"よ", "katakana": "ヨ", "tries": null},
        {"sound":"RA","hiragana":"ら", "katakana": "ラ", "tries": null},
        {"sound":"RI","hiragana":"り", "katakana": "リ", "tries": null},
        {"sound":"RU","hiragana":"る", "katakana": "ル", "tries": null},
        {"sound":"RE","hiragana":"れ", "katakana": "レ", "tries": null},
        {"sound":"RO","hiragana":"ろ", "katakana": "ロ", "tries": null},
        {"sound":"WA","hiragana":"わ", "katakana": "ワ", "tries": null},
        {"sound":"WO","hiragana":"を", "katakana": "ヲ", "tries": null},
        {"sound":"N","hiragana":"ん", "katakana": "ン", "tries": null},
        /*{"extended": true, "sound":"KYA","hiragana":"きゃ", "katakana": "キャ", "tries": null},
        {"extended": true, "sound":"KYU","hiragana":"きゅ", "katakana": "キュ", "tries": null},
        {"extended": true, "sound":"KYO","hiragana":"きょ", "katakana": "キョ", "tries": null},
        {"extended": true, "sound":"GYA","hiragana":"ぎゃ", "katakana": "ギャ", "tries": null},
        {"extended": true, "sound":"GYU","hiragana":"ぎゅ", "katakana": "ギュ", "tries": null},
        {"extended": true, "sound":"GYO","hiragana":"ぎょ", "katakana": "ギョ", "tries": null},
        {"extended": true, "sound":"NYA","hiragana":"にゃ", "katakana": "ニャ", "tries": null},
        {"extended": true, "sound":"NYU","hiragana":"にゅ", "katakana": "ニュ", "tries": null},
        {"extended": true, "sound":"NYO","hiragana":"にょ", "katakana": "ニョ", "tries": null},
        {"extended": true, "sound":"HYA","hiragana":"ひゃ", "katakana": "ヒャ", "tries": null},
        {"extended": true, "sound":"HYU","hiragana":"ひゅ", "katakana": "ヒュ", "tries": null},
        {"extended": true, "sound":"HYO","hiragana":"ひょ", "katakana": "ヒョ", "tries": null},
        {"extended": true, "sound":"BYA","hiragana":"びゃ", "katakana": "ビャ", "tries": null},
        {"extended": true, "sound":"BYU","hiragana":"びゅ", "katakana": "ビュ", "tries": null},
        {"extended": true, "sound":"BYO","hiragana":"びょ", "katakana": "ビョ", "tries": null},
        {"extended": true, "sound":"PYA","hiragana":"ぴゃ", "katakana": "ピャ", "tries": null},
        {"extended": true, "sound":"PYU","hiragana":"ぴゅ", "katakana": "ピュ", "tries": null},
        {"extended": true, "sound":"PYO","hiragana":"ぴょ", "katakana": "ピョ", "tries": null},
        {"extended": true, "sound":"MYA","hiragana":"みゃ", "katakana": "ミャ", "tries": null},
        {"extended": true, "sound":"MYU","hiragana":"みゅ", "katakana": "ミュ", "tries": null},
        {"extended": true, "sound":"MYO","hiragana":"みょ", "katakana": "ミョ", "tries": null},
        {"extended": true, "sound":"RYA","hiragana":"りゃ", "katakana": "リャ", "tries": null},
        {"extended": true, "sound":"RYU","hiragana":"りゅ", "katakana": "リュ", "tries": null},
        {"extended": true, "sound":"RYO","hiragana":"りょ", "katakana": "リョ", "tries": null},*/
      ];

      
    </script>
  </body>
</html>
